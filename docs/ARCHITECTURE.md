# ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» RAG Go Server çš„æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹å’Œå®ç°åŸç†ã€‚

## ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
- [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)

---

## ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®èƒŒæ™¯

WHU è¯¾ç¨‹æ¨èç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº RAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€æœ¯çš„æ™ºèƒ½è¯¾ç¨‹æ¨èæœåŠ¡ã€‚ç³»ç»Ÿé€šè¿‡è¯­ä¹‰æ£€ç´¢å’Œå¤§è¯­è¨€æ¨¡å‹ï¼Œå¸®åŠ©å­¦ç”Ÿæ ¹æ®è‡ªç„¶è¯­è¨€æè¿°æ‰¾åˆ°ç¬¦åˆéœ€æ±‚çš„è¯¾ç¨‹ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **è¯­ä¹‰æ£€ç´¢**ï¼šç†è§£ç”¨æˆ·çš„æ¨¡ç³Šéœ€æ±‚ï¼ˆå¦‚"è½»æ¾çš„è¯¾"ã€"æ²¡æœ‰è€ƒè¯•çš„è¯¾"ï¼‰
2. **æ™ºèƒ½æ¨è**ï¼šç»“åˆæ£€ç´¢ç»“æœå’Œ LLM ç”Ÿæˆä¸ªæ€§åŒ–æ¨èç†ç”±
3. **è®¿é—®æ§åˆ¶**ï¼šåŸºäºè®¾å¤‡æŒ‡çº¹çš„åˆ†å¸ƒå¼é™æµ
4. **åˆ†ç±»ç­›é€‰**ï¼šæ”¯æŒæŒ‰è¯¾ç¨‹ç±»å‹è¿‡æ»¤

### è®¾è®¡ç›®æ ‡

- **å‡†ç¡®æ€§**ï¼šæ¨èç»“æœä¸ç”¨æˆ·éœ€æ±‚é«˜åº¦ç›¸å…³
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ‰©å±•åˆ°æ›´å¤šè¯¾ç¨‹æ•°æ®å’ŒåŠŸèƒ½
- **é«˜æ€§èƒ½**ï¼šå•æ¬¡è¯·æ±‚åœ¨ 2 ç§’å†…å®Œæˆ
- **æ˜“ç»´æŠ¤**ï¼šæ¨¡å—è§£è€¦ï¼Œä¾¿äºå‡çº§å’Œæ›¿æ¢ç»„ä»¶

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯åº”ç”¨å±‚                          â”‚
â”‚   (Web å‰ç«¯ / å°ç¨‹åº / ç§»åŠ¨ App / API å®¢æˆ·ç«¯)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP/HTTPS
                         â”‚ POST /rag
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Gin HTTP Server                         â”‚
â”‚                    (Go Web Framework)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              HTTP Handler å±‚                         â”‚  â”‚
â”‚  â”‚  - è¯·æ±‚éªŒè¯ï¼ˆè®¾å¤‡æŒ‡çº¹ã€å‚æ•°æ ¡éªŒï¼‰                   â”‚  â”‚
â”‚  â”‚  - å“åº”å°è£…ï¼ˆç»Ÿä¸€ JSON æ ¼å¼ï¼‰                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RAG Service å±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           RAG åè°ƒå™¨ (Orchestrator)                  â”‚  â”‚
â”‚  â”‚  - æµç¨‹ç¼–æ’ï¼šé™æµ â†’ å‘é‡åŒ– â†’ æ£€ç´¢ â†’ ç”Ÿæˆ â†’ è§£æ    â”‚  â”‚
â”‚  â”‚  - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”
    â”‚ Limiterâ”‚ â”‚Embedâ”‚ â”‚ Vector  â”‚ â”‚ LLM  â”‚
    â”‚        â”‚ â”‚-dingâ”‚ â”‚ Store   â”‚ â”‚Clientâ”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”€â”€â”˜
         â”‚        â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redis     â”‚  â”‚  â”‚  Qdrant   â”‚ â”‚  DeepSeek    â”‚
â”‚  (é™æµå­˜å‚¨)  â”‚  â”‚  â”‚ (å‘é‡DB)  â”‚ â”‚  Chat API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Cloudflare   â”‚
          â”‚     Worker     â”‚
          â”‚ (BGE-M3 Model) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚æ¶æ„

#### 1. æ¥å£å±‚ (HTTP Handler)

**èŒè´£**ï¼š
- æ¥æ”¶å’ŒéªŒè¯ HTTP è¯·æ±‚
- æå–è®¾å¤‡æŒ‡çº¹å’Œä¸šåŠ¡å‚æ•°
- è°ƒç”¨ä¸šåŠ¡å±‚æœåŠ¡
- å°è£…å“åº”æ•°æ®

**å…³é”®ç»„ä»¶**ï¼š
- `handler.go`: Gin è·¯ç”±å¤„ç†å™¨

**è®¾è®¡æ¨¡å¼**ï¼š
- Handler å‡½æ•°é€šè¿‡é—­åŒ…æ³¨å…¥ä¾èµ–
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- HTTP çŠ¶æ€ç è¯­ä¹‰åŒ–

#### 2. ä¸šåŠ¡å±‚ (RAG Service)

**èŒè´£**ï¼š
- ç¼–æ’ RAG å®Œæ•´æµç¨‹
- åè°ƒå„ä¸ªå­æ¨¡å—
- ä¸šåŠ¡é€»è¾‘æ§åˆ¶

**å…³é”®ç»„ä»¶**ï¼š
- `service.go`: RAG æœåŠ¡ä¸»é€»è¾‘
- `ParseLLMOutput()`: LLM è¾“å‡ºè§£æ

**æµç¨‹æ§åˆ¶**ï¼š
```go
func (s *Service) HandleRag(ctx, req, fingerprint) {
    // 1. é™æµæ£€æŸ¥
    if !limiter.Allow(fingerprint) {
        return ErrQuotaExceeded
    }
    
    // 2. ç”¨æˆ·é—®é¢˜ â†’ å‘é‡
    vec := embedder.Embed(req.UserQuestion)
    
    // 3. å‘é‡æ£€ç´¢
    courses := vectorStore.Search(vec, req.Category)
    
    // 4. LLM ç”Ÿæˆæ¨è
    llmOutput := llm.RecommendCourses(req.UserQuestion, courses)
    
    // 5. è§£æç»“æ„åŒ–è¾“å‡º
    recommendations := ParseLLMOutput(llmOutput)
    
    return recommendations
}
```

#### 3. åŸºç¡€è®¾æ–½å±‚ (Infrastructure)

**å­æ¨¡å—**ï¼š

1. **é™æµå™¨ (Limiter)**
   - Redis å­˜å‚¨é…é¢
   - æŒ‰è®¾å¤‡æŒ‡çº¹è®¡æ•°
   - è‡ªåŠ¨è¿‡æœŸæœºåˆ¶

2. **å‘é‡åµŒå…¥ (Embedding)**
   - Cloudflare Worker å°è£… BGE-M3
   - æ–‡æœ¬ â†’ 1024 ç»´å‘é‡

3. **å‘é‡å­˜å‚¨ (Vector Store)**
   - Qdrant å‘é‡æ•°æ®åº“
   - åŸºäºä½™å¼¦ç›¸ä¼¼åº¦æ£€ç´¢
   - æ”¯æŒåˆ†ç±»è¿‡æ»¤

4. **å¤§è¯­è¨€æ¨¡å‹ (LLM Client)**
   - DeepSeek Chat API
   - ç³»ç»Ÿæç¤ºè¯ç®¡ç†
   - æµå¼/éæµå¼è¾“å‡º

#### 4. å¤–éƒ¨æœåŠ¡å±‚

**ä¾èµ–æœåŠ¡**ï¼š
- **Qdrant Cloud**: å‘é‡æ•°æ®åº“
- **Redis**: ç¼“å­˜å’Œé™æµ
- **DeepSeek API**: å¤§è¯­è¨€æ¨¡å‹
- **Cloudflare Worker**: å‘é‡åµŒå…¥æœåŠ¡

---

## æ ¸å¿ƒæ¨¡å—

### 1. é…ç½®ç®¡ç† (config)

**è®¾è®¡æ€è·¯**ï¼š
- ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®
- å¿…å¡«é¡¹æ ¡éªŒ
- åˆç†é»˜è®¤å€¼

**é…ç½®é¡¹**ï¼š
```go
type Config struct {
    OpenAIAPIKey   string  // DeepSeek API å¯†é’¥
    QdrantHost     string  // Qdrant åœ°å€
    QdrantAPIKey   string  // Qdrant å¯†é’¥
    RedisAddr      string  // Redis åœ°å€
    RedisPassword  string  // Redis å¯†ç 
    EmbedEndpoint  string  // å‘é‡åŒ–æœåŠ¡åœ°å€
    ListenAddr     string  // HTTP ç›‘å¬åœ°å€
    LimitPerDevice int     // æ¯è®¾å¤‡é…é¢
}
```

**åŠ è½½æµç¨‹**ï¼š
1. è¯»å–ç¯å¢ƒå˜é‡
2. åº”ç”¨é»˜è®¤å€¼
3. éªŒè¯å¿…å¡«é¡¹
4. è¿”å›é…ç½®å¯¹è±¡

### 2. é™æµå™¨ (limit)

**é™æµç­–ç•¥**ï¼š
- **ç»´åº¦**ï¼šè®¾å¤‡æŒ‡çº¹
- **ç®—æ³•**ï¼šå›ºå®šçª—å£è®¡æ•°å™¨
- **å‘¨æœŸ**ï¼šæ¯å‘¨ï¼ˆå‘¨å›› 00:00 é‡ç½®ï¼‰
- **é…é¢**ï¼š10 æ¬¡/å‘¨ï¼ˆå¯é…ç½®ï¼‰

**å®ç°åŸç†**ï¼š
```
Redis Key: limit:{fingerprint}
Redis Value: å‰©ä½™æ¬¡æ•°ï¼ˆæ•´æ•°ï¼‰
Redis TTL: åˆ°ä¸‹å‘¨å›› 00:00 çš„ç§’æ•°

æ¯æ¬¡è¯·æ±‚ï¼š
1. æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨
   - ä¸å­˜åœ¨ï¼šSET limit:{fp} 10 EX {ttl}
   - å­˜åœ¨ï¼šç»§ç»­
2. GET limit:{fp}
   - å€¼ > 0ï¼šDECR limit:{fp}ï¼Œå…è®¸è®¿é—®
   - å€¼ <= 0ï¼šæ‹’ç»è®¿é—®ï¼Œè¿”å› 429
```

**ä¼˜åŠ¿**ï¼š
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¿è¯ä¸€è‡´æ€§
- è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
- Redis åŸå­æ“ä½œï¼Œå¹¶å‘å®‰å…¨

### 3. å‘é‡åµŒå…¥ (embedding)

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- **æ¨¡å‹**ï¼šBGE-M3 (BAAI)
- **ç»´åº¦**ï¼š1024
- **éƒ¨ç½²**ï¼šCloudflare Worker
- **æ¥å£**ï¼šHTTP POST

**ä¸ºä»€ä¹ˆé€‰æ‹© Cloudflare Workerï¼Ÿ**
- âœ… å…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ï¼Œä½å»¶è¿Ÿ
- âœ… è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œé›¶è¿ç»´
- âœ… å…è´¹é¢åº¦å……è¶³
- âœ… é¿å…åœ¨ Go æœåŠ¡ä¸­åŠ è½½å¤§æ¨¡å‹

**æ¥å£è®¾è®¡**ï¼š
```typescript
// Cloudflare Worker
export default {
  async fetch(request: Request): Promise<Response> {
    const { text } = await request.json();
    const embedding = await model.encode(text);
    return new Response(JSON.stringify({
      embedding: { data: [embedding] }
    }));
  }
}
```

### 4. å‘é‡å­˜å‚¨ (vectorstore)

**æ•°æ®åº“é€‰æ‹©**ï¼šQdrant

**ä¸ºä»€ä¹ˆé€‰æ‹© Qdrantï¼Ÿ**
- âœ… ä¸“ä¸ºå‘é‡æ£€ç´¢ä¼˜åŒ–
- âœ… æ”¯æŒ Payload å­˜å‚¨ï¼ˆè¯¾ç¨‹å…ƒæ•°æ®ï¼‰
- âœ… è¿‡æ»¤æŸ¥è¯¢ï¼ˆæŒ‰åˆ†ç±»ç­›é€‰ï¼‰
- âœ… gRPC å’Œ HTTP åŒæ¥å£
- âœ… Cloud æœåŠ¡å¼€ç®±å³ç”¨

**æ•°æ®ç»“æ„**ï¼š
```json
{
  "id": "course_001",
  "vector": [0.123, 0.456, ...],  // 1024 ç»´
  "payload": {
    "text": "è¯¾ç¨‹åç§°ï¼š...",
    "catagory": 2
  }
}
```

**æ£€ç´¢æµç¨‹**ï¼š
```go
func (s *QdrantStore) Search(vec []float32, category int, limit int) {
    req := &qdrant.QueryPoints{
        CollectionName: "WHUCoursesDB",
        Query:          NewQuery(vec...),
        Limit:          limit,
        WithPayload:    true,
    }
    
    resp := s.Client.Query(ctx, req)
    
    // å®¢æˆ·ç«¯è¿‡æ»¤åˆ†ç±»
    for _, point := range resp {
        if category == 0 || point.Payload["catagory"] == category {
            matches = append(matches, point.Payload)
        }
    }
    
    return matches
}
```

### 5. å¤§è¯­è¨€æ¨¡å‹ (llm)

**æ¨¡å‹é€‰æ‹©**ï¼šDeepSeek Chat

**ä¸ºä»€ä¹ˆé€‰æ‹© DeepSeekï¼Ÿ**
- âœ… ä¸­æ–‡èƒ½åŠ›å¼º
- âœ… æ€§ä»·æ¯”é«˜
- âœ… OpenAI å…¼å®¹æ¥å£
- âœ… æ”¯æŒ JSON è¾“å‡º

**Prompt è®¾è®¡**ï¼š
```text
System:
ä½ æ˜¯ä¸€ä¸ªè¯¾ç¨‹é€‰æ‹©åŠ©æ‰‹ã€‚
...
è¾“å‡ºæ ¼å¼ï¼š<|Result|>[{...}]

User:
è¯¾ç¨‹åˆ—è¡¨: ["è¯¾ç¨‹1æè¿°", "è¯¾ç¨‹2æè¿°", ...]
ç”¨æˆ·æé—®: æˆ‘æƒ³é€‰è½»æ¾çš„è¯¾
```

**è¾“å‡ºè§£æ**ï¼š
1. å®šä½ `<|Result|>` åˆ†éš”ç¬¦
2. æå–åˆ†éš”ç¬¦åçš„ JSON
3. ååºåˆ—åŒ–ä¸º `[]CourseRecommendation`

---

## æ•°æ®æµç¨‹

### å®Œæ•´è¯·æ±‚æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥
   â†“
   "æˆ‘æƒ³é€‰æ²¡æœ‰æœŸæœ«è€ƒè¯•çš„è¯¾"
   
2. HTTP è¯·æ±‚
   â†“
   POST /rag
   Headers: X-Device-Fingerprint
   Body: {userQuestion, catagory}
   
3. é™æµæ£€æŸ¥
   â†“
   Redis GET limit:{fingerprint}
   â†’ å‰©ä½™é…é¢ > 0 ? ç»§ç»­ : è¿”å› 429
   
4. å‘é‡åŒ–
   â†“
   Cloudflare Worker (BGE-M3)
   "æˆ‘æƒ³é€‰..." â†’ [0.123, 0.456, ..., 0.789]
   
5. å‘é‡æ£€ç´¢
   â†“
   Qdrant.Query(vector, limit=100)
   â†’ Top 100 ç›¸ä¼¼è¯¾ç¨‹
   
6. åˆ†ç±»è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
   â†“
   if catagory != 0:
       filter courses by catagory
   
7. LLM ç”Ÿæˆ
   â†“
   DeepSeek Chat API
   System Prompt + è¯¾ç¨‹åˆ—è¡¨ + ç”¨æˆ·é—®é¢˜
   â†’ "åˆ†æï¼š...  <|Result|>[{...}, {...}]"
   
8. ç»“æœè§£æ
   â†“
   æå– JSON éƒ¨åˆ†
   â†’ [{course: "è¯¾ç¨‹A", reason: "..."}]
   
9. å“åº”è¿”å›
   â†“
   {status: "success", data: {recommendations: [...]}}
```

### ç´¢å¼•æ„å»ºæµç¨‹

```
1. å‡†å¤‡æ•°æ®
   â†“
   courses.csv (è¯¾ç¨‹åç§°, æ•™å¸ˆ, è¯„ä»·, ...)
   
2. æ•°æ®æ¸…æ´—
   â†“
   æ ¼å¼åŒ–ä¸ºç»“æ„åŒ–æ–‡æœ¬
   "è¯¾ç¨‹åç§°ï¼š...ã€‚æˆè¯¾æ•™å¸ˆï¼š...ã€‚"
   
3. æ‰¹é‡å‘é‡åŒ–
   â†“
   for each course:
       vec = BGE-M3.encode(text)
   
4. æ„å»º FAISS ç´¢å¼•ï¼ˆæœ¬åœ°ï¼‰
   â†“
   index = faiss.IndexFlatL2(1024)
   index.add(all_vectors)
   
5. ä¸Šä¼ åˆ° Qdrant
   â†“
   for each (vec, text, category):
       qdrant.upsert(
           vector=vec,
           payload={text, category}
       )
   
6. éªŒè¯ç´¢å¼•
   â†“
   qdrant.search(test_vector, limit=3)
   â†’ æ£€æŸ¥ç»“æœç›¸å…³æ€§
```

---

## æŠ€æœ¯é€‰å‹

### ç¼–ç¨‹è¯­è¨€

| ç»„ä»¶         | è¯­è¨€       | ç†ç”±                               |
| ------------ | ---------- | ---------------------------------- |
| åç«¯æœåŠ¡     | Go         | é«˜æ€§èƒ½ã€å¹¶å‘å‹å¥½ã€éƒ¨ç½²ç®€å•         |
| ç´¢å¼•æ„å»º     | Python     | ç”Ÿæ€ä¸°å¯Œã€FAISS/Qdrant å®˜æ–¹æ”¯æŒ    |
| å‘é‡åŒ–æœåŠ¡   | TypeScript | Cloudflare Worker å®˜æ–¹è¯­è¨€         |

### æ¡†æ¶å’Œåº“

#### Go åç«¯

| åº“               | ç”¨é€”           | ç†ç”±                     |
| ---------------- | -------------- | ------------------------ |
| gin-gonic/gin    | Web æ¡†æ¶       | è½»é‡ã€æ€§èƒ½é«˜ã€ä¸­é—´ä»¶ä¸°å¯Œ |
| go-redis         | Redis å®¢æˆ·ç«¯   | å®˜æ–¹æ¨èã€åŠŸèƒ½å®Œå–„       |
| qdrant-go-client | Qdrant å®¢æˆ·ç«¯  | å®˜æ–¹ SDKã€gRPC æ”¯æŒ      |
| godotenv         | ç¯å¢ƒå˜é‡       | ç®€åŒ–é…ç½®ç®¡ç†             |

#### Python ç´¢å¼•æ„å»º

| åº“              | ç”¨é€”         | ç†ç”±                   |
| --------------- | ------------ | ---------------------- |
| faiss-cpu       | å‘é‡ç´¢å¼•     | Meta å¼€æºã€æ€§èƒ½æœ€ä¼˜    |
| qdrant-client   | Qdrant SDK   | å®˜æ–¹ Python å®¢æˆ·ç«¯     |
| FlagEmbedding   | BGE-M3 æ¨¡å‹  | æ™ºæºå®˜æ–¹å®ç°           |
| pandas          | æ•°æ®å¤„ç†     | ç”Ÿæ€æˆç†Ÿã€æ˜“ç”¨         |

### å¤–éƒ¨æœåŠ¡

| æœåŠ¡              | ç”¨é€”         | é€‰å‹ç†ç”±                       |
| ----------------- | ------------ | ------------------------------ |
| Qdrant Cloud      | å‘é‡æ•°æ®åº“   | ä¸“ä¸šå‘é‡æ£€ç´¢ã€å…è´¹é¢åº¦å……è¶³     |
| Redis             | ç¼“å­˜/é™æµ    | ä¸šç•Œæ ‡å‡†ã€åŸå­æ“ä½œæ”¯æŒ         |
| DeepSeek API      | å¤§è¯­è¨€æ¨¡å‹   | ä¸­æ–‡èƒ½åŠ›å¼ºã€æ€§ä»·æ¯”é«˜           |
| Cloudflare Worker | å‘é‡åµŒå…¥æœåŠ¡ | å…¨çƒè¾¹ç¼˜éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹       |

---

## æ€§èƒ½ä¼˜åŒ–

### å“åº”æ—¶é—´åˆ†è§£

å…¸å‹è¯·æ±‚çš„è€—æ—¶åˆ†å¸ƒï¼ˆåŸºäºå®æµ‹ï¼‰ï¼š

| é˜¶æ®µ            | è€—æ—¶       | å æ¯” |
| --------------- | ---------- | ---- |
| é™æµæ£€æŸ¥        | 5-10 ms    | 1%   |
| å‘é‡åŒ–          | 50-200 ms  | 10%  |
| å‘é‡æ£€ç´¢        | 30-100 ms  | 5%   |
| LLM ç”Ÿæˆ        | 1-2 s      | 80%  |
| ç»“æœè§£æ        | 5-10 ms    | 1%   |
| **æ€»è®¡**        | **1.5-2.5s**| **100%** |

### ä¼˜åŒ–ç­–ç•¥

#### 1. å‘é‡åŒ–åŠ é€Ÿ

**å½“å‰æ–¹æ¡ˆ**ï¼šCloudflare Worker

**å¤‡é€‰æ–¹æ¡ˆ**ï¼š
- æœ¬åœ°éƒ¨ç½² BGE-M3ï¼ˆéœ€è¦ GPUï¼‰
- ä½¿ç”¨ OpenAI Embeddings API
- ç¼“å­˜å¸¸è§é—®é¢˜çš„å‘é‡

#### 2. æ£€ç´¢ä¼˜åŒ–

**å½“å‰**ï¼šæ£€ç´¢ Top 100

**ä¼˜åŒ–æ–¹å‘**ï¼š
- å‡å°‘ limitï¼ˆæƒè¡¡å¬å›ç‡ï¼‰
- ä½¿ç”¨ Qdrant çš„è¿‘ä¼¼ç´¢å¼•ï¼ˆHNSWï¼‰
- æ·»åŠ é¢„è¿‡æ»¤æ¡ä»¶

#### 3. LLM åŠ é€Ÿ

**å½“å‰ç“¶é¢ˆ**ï¼šLLM æ¨ç†è€—æ—¶æœ€é•¿

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- æµå¼è¾“å‡ºï¼ˆSSEï¼‰
- å‡å°‘è¾“å…¥ token æ•°é‡
- ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ DeepSeek-Liteï¼‰
- ç¼“å­˜çƒ­é—¨é—®é¢˜çš„å›ç­”

#### 4. å¹¶å‘æ§åˆ¶

```go
// ä½¿ç”¨ context æ§åˆ¶è¶…æ—¶
ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
defer cancel()

// è®¾ç½®åˆç†çš„è¿æ¥æ± 
httpClient := &http.Client{
    Timeout: 10 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
    },
}
```

---

## å®‰å…¨è®¾è®¡

### 1. API å®‰å…¨

**è®¾å¤‡æŒ‡çº¹éªŒè¯**ï¼š
- æ¯ä¸ªè¯·æ±‚å¿…é¡»æºå¸¦è®¾å¤‡æŒ‡çº¹
- é˜²æ­¢æœªæˆæƒè®¿é—®

**é™æµä¿æŠ¤**ï¼š
- é˜²æ­¢å•è®¾å¤‡æ¶æ„åˆ·æ¥å£
- åŸºäº Redis çš„åˆ†å¸ƒå¼é™æµ

**è¾“å…¥éªŒè¯**ï¼š
```go
// é•¿åº¦æ£€æŸ¥
if len(req.UserQuestion) > 500 {
    return ErrQuestionTooLong
}

// æ•æ„Ÿè¯è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
if containsSensitiveWords(req.UserQuestion) {
    return ErrInvalidInput
}
```

### 2. æ•°æ®å®‰å…¨

**æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**ï¼š
- API å¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–
- ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ AWS Secrets Managerï¼‰

**æ•°æ®ä¼ è¾“**ï¼š
- ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS
- è¯ä¹¦è‡ªåŠ¨ç»­æœŸï¼ˆLet's Encryptï¼‰

### 3. æ—¥å¿—å’Œç›‘æ§

**æ—¥å¿—çº§åˆ«**ï¼š
```go
log.Printf("ğŸ”¹ ç”¨æˆ·é—®é¢˜åµŒå…¥å‘é‡ç”Ÿæˆå®Œæ¯•")        // INFO
log.Printf("âš ï¸ è¯·æ±‚ç¼ºå°‘è®¾å¤‡æŒ‡çº¹")              // WARN
log.Printf("âŒ RAG å¤„ç†å¤±è´¥: %v", err)        // ERROR
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- è¯·æ±‚æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- é™æµæ‹’ç»æ¬¡æ•°
- LLM è°ƒç”¨å¤±è´¥ç‡

---

## æ‰©å±•æ€§è®¾è®¡

### 1. æ¨¡å—è§£è€¦

**æ¥å£é©±åŠ¨**ï¼š
```go
type Client interface {
    Embed(ctx context.Context, text string) ([]float32, error)
}

type Store interface {
    Search(ctx context.Context, vector []float32, ...) ([]map[string]interface{}, error)
}

type LLMClient interface {
    RecommendCourses(ctx context.Context, ...) (string, error)
}
```

**ä¾èµ–æ³¨å…¥**ï¼š
```go
ragService := rag.NewService(
    embedder,    // å¯æ›¿æ¢ä¸ºä¸åŒçš„å‘é‡åŒ–æœåŠ¡
    store,       // å¯æ›¿æ¢ä¸ºä¸åŒçš„å‘é‡æ•°æ®åº“
    llmClient,   // å¯æ›¿æ¢ä¸ºä¸åŒçš„å¤§æ¨¡å‹
    limiter,     // å¯æ›¿æ¢ä¸ºä¸åŒçš„é™æµç­–ç•¥
)
```

### 2. æ°´å¹³æ‰©å±•

**æ— çŠ¶æ€æœåŠ¡**ï¼š
- Go æœåŠ¡ä¸å­˜å‚¨çŠ¶æ€
- çŠ¶æ€å­˜å‚¨åœ¨ Redis å’Œ Qdrant
- æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

**è´Ÿè½½å‡è¡¡**ï¼š
```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Nginx/ALBâ”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”
â”‚ Go 1 â”‚ â”‚ Go 2 â”‚ â”‚ Go N â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
      â”‚Redis/Qdrant â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. åŠŸèƒ½æ‰©å±•

**æœªæ¥æ–¹å‘**ï¼š
- å¤šè½®å¯¹è¯æ”¯æŒ
- ä¸ªæ€§åŒ–æ¨èï¼ˆåŸºäºå†å²ï¼‰
- æ›´ç»†ç²’åº¦çš„åˆ†ç±»
- è¯¾ç¨‹è¯„åˆ†ç³»ç»Ÿ
- A/B æµ‹è¯•æ¡†æ¶

---

## å‚è€ƒèµ„æ–™

### è®ºæ–‡å’Œæ–‡æ¡£

- [Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks](https://arxiv.org/abs/2005.11401)
- [BGE M3-Embedding](https://arxiv.org/abs/2402.03216)
- [Qdrant Documentation](https://qdrant.tech/documentation/)
- [FAISS: A Library for Efficient Similarity Search](https://arxiv.org/abs/1702.08734)

### å¼€æºé¡¹ç›®

- [Gin Web Framework](https://github.com/gin-gonic/gin)
- [Qdrant Vector Database](https://github.com/qdrant/qdrant)
- [BGE M3 Embedding](https://github.com/FlagOpen/FlagEmbedding)
- [FAISS](https://github.com/facebookresearch/faiss)

